#!/usr/bin/python

import json
import os
import subprocess
import signal

HOME = "/home/saeed"
CONFIG_PATH = f"{HOME}/.config"
KITTY_PATH = f"{CONFIG_PATH}/kitty"
KITTY_THEMES_PATH = f"{CONFIG_PATH}/kitty/themes"
ROFI_PATH = f"{CONFIG_PATH}/rofi"
ROFI_THEMES_PATH = f"{CONFIG_PATH}/rofi/themes"
DUNST_PATH = f"{CONFIG_PATH}/dunst"
DUNST_THEMES_PATH = f"{CONFIG_PATH}/dunst/themes"
NEOVIM_PATH = f"{CONFIG_PATH}/nvim"
QTILE_PATH = f"{CONFIG_PATH}/qtile"


def readfile(filename):
    with open(filename) as f:
        lines = f.readlines()
    return lines


def writefile(filename, lines):
    with open(filename, "w") as colorscheme_file:
        for line in lines:
            colorscheme_file.write(line)
    return True


def updatefile(lines, old, new):
    for index, line in enumerate(lines[:]):
        if old in line:
            lines[index] = new
            return lines


def themes_dict():
    with open("/home/saeed/.local/bin/scripts/newlook.json") as json_file:
        themes = json.load(json_file)
        return themes


def print_themes():
    for theme in themes_dict():
        print(theme.get("id"), theme.get("name"))


def get_theme_by_id(theme_id: str):
    for theme in themes_dict():
        if theme.get("id") == theme_id:
            return theme.get("name")
    return 0


def apply_theme_neovim(theme_name):
    # theme nvim package name
    nvim_theme_name = ""
    for theme in themes_dict():
        if theme.get("name") == theme_name:
            nvim_theme_name = theme.get("nvim")

    theme_name = nvim_theme_name or theme_name
    # filename
    filename = f"{NEOVIM_PATH}/lua/plugins/colors.lua"
    # read
    lines = readfile(filename)
    # update
    old_line = "local colorscheme = "
    new_line = f'local colorscheme = "{nvim_theme_name}"\n'
    lines = updatefile(lines, old_line, new_line)
    # write
    writefile(filename, lines)


def apply_theme_qtile(theme_name: str):
    screen_file = f"{QTILE_PATH}/modules/screen.py"
    lines = readfile(screen_file)
    # update
    old_line = "from .colors import"
    new_line = f"from .colors import {theme_name.title()} as c\n"
    lines = updatefile(lines, old_line, new_line)
    # write file
    writefile(screen_file, lines)
    # set theme color in core for border color
    core_file = f"{QTILE_PATH}/modules/core.py"
    lines = readfile(core_file)
    # update
    old_line = "from .colors import"
    new_line = f"from .colors import {theme_name.title()} as c\n"
    lines = updatefile(lines, old_line, new_line)
    # write file
    writefile(core_file, lines)
    # reload qtile
    qtile_reload_cmd = "qtile cmd-obj -o cmd -f reload_config"
    os.system(qtile_reload_cmd)


def apply_kitty(theme_name):
    # applay theme for kitty
    cmd = f"cp {KITTY_PATH}/themes/{theme_name}.conf {KITTY_PATH}/kitty.conf"
    os.system(cmd)
    # command to reload kitty
    pids_raw = subprocess.check_output(["pidof", "kitty"])
    pids = [int(pid) for pid in pids_raw.decode().split()]
    for pid in pids:
        os.kill(pid, signal.SIGUSR1)


def apply_rofi(theme_name):
    cmd = f"cp {ROFI_THEMES_PATH}/{theme_name}.rasi {ROFI_PATH}/config.rasi"
    os.system(cmd)


def apply_dunst(theme_name):
    cmd = f"cp {DUNST_THEMES_PATH}/{theme_name} {DUNST_PATH}/dunstrc"
    os.system(cmd)
    os.system("killall dunst && dunst &")


def apply_theme(theme_name: str):
    apply_kitty(theme_name)
    apply_rofi(theme_name)
    apply_dunst(theme_name)
    apply_theme_neovim(theme_name)
    apply_theme_qtile(theme_name)
    print("Theme changed successfully:-)")


def choose_theme():
    print_themes()
    user_response = input("Choose theme number: ")
    theme = get_theme_by_id(user_response)
    print(theme)
    if theme:
        print(f"Applying theme ...{theme}")
        apply_theme(theme)
    else:
        print("Invalid choice.")


def main():
    choose_theme()


if __name__ == "__main__":
    main()
